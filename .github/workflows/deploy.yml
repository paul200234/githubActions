name: Deploy Spring Boot to EC2 (Ubuntu)  # Nombre del workflow

on:
  push:                                 # Workflow activa cuando se hace push.
    branches:
      - main                            # Solo se ejecuta si push en rama main

jobs:
  build-and-deploy:                     # Define trabajo llamado build-and-deploy
    runs-on: ubuntu-latest              # El trabajo se ejecuta en Ubuntu

    steps:
      # 1️⃣ Descargar el código fuente del repositorio
      - name: Checkout source code       # Nombre del paso.
        uses: actions/checkout@v4        # Versión actualizada

      # 2️⃣ Configurar JDK 21 (Java Development Kit)
      - name: Set up JDK 21             # Nombre del paso.
        uses: actions/setup-java@v4      # Versión actualizada
        with:
          distribution: 'temurin'        # Comillas para string
          java-version: '21'             # Comillas para string

      # 3️⃣ Construir la aplicación usando Maven
      - name: Build with Maven          # Nombre del paso.
        run: mvn clean package -DskipTests  # Opcional: saltar tests

      # 4️⃣ Verificar que el archivo .war existe
      - name: Verify .war file exists   # Nuevo paso para debugging
        run: |
          ls -la target/*.war
          echo "War file should be: target/demo-0.0.1-SNAPSHOT.war"

      # 5️⃣ Copiar el archivo .war a la instancia EC2
      - name: Copy .war to EC2          # Nombre del paso.
        uses: appleboy/scp-action@v0.1.7  # Versión actualizada
        with:
          host: ${{ secrets.EC2_HOST }}    # Dirección IP de la instancia EC2 
          username: ${{ secrets.EC2_USERNAME }}  # Nombre usuario EC2
          key: ${{ secrets.EC2_PRIVATE_KEY }}    # Clave privada SSH 
          port: 22                          # Puerto SSH explícito
          source: "target/*.war"            # Patrón para capturar cualquier .war
          target: /home/ubuntu/             # Carpeta destino en EC2
          rm: true                          # Eliminar archivos existentes

      # 6️⃣ Desplegar en Tomcat y configurar
      - name: Deploy to Tomcat and configure  
        uses: appleboy/ssh-action@v1.0.3    # Versión específica
        with:
          host: ${{ secrets.EC2_HOST }}         # Dirección IP de EC2
          username: ${{ secrets.EC2_USERNAME }} # Nombre de usuario de EC2
          key: ${{ secrets.EC2_PRIVATE_KEY }}   # Clave privada SSH 
          port: 22                               # Puerto SSH explícit
          script: |
            # Encontrar el archivo .war recién copiado
            WAR_FILE=$(find /home/ubuntu -name "*.war" -type f | head -1)
            
            if [ -z "$WAR_FILE" ]; then
              echo "Error: No .war file found in /home/ubuntu/"
              exit 1
            fi
            
            echo "Found WAR file: $WAR_FILE"
            
            # Detener Tomcat antes de mover el archivo
            sudo systemctl stop tomcat10
            
            # Eliminar despliegue anterior si existe
            sudo rm -f /var/lib/tomcat10/webapps/demo.war
            sudo rm -rf /var/lib/tomcat10/webapps/demo
            
            # Mover el archivo .war a la carpeta de despliegue de Tomcat.
            sudo mv "$WAR_FILE" /var/lib/tomcat10/webapps/demo.war
            
            # Cambiar el propietario del archivo a "tomcat"
            sudo chown tomcat:tomcat /var/lib/tomcat10/webapps/demo.war
            
            # Cambiar los permisos del archivo
            sudo chmod 755 /var/lib/tomcat10/webapps/demo.war
            
            # Limpiar directorio temporal
            rm -f /home/ubuntu/*.war
            
            # Reiniciar el servicio Tomcat
            sudo systemctl start tomcat10
            
            # Verificar que Tomcat está funcionando
            sleep 10
            sudo systemctl status tomcat10 --no-pager
            
            # Verificar el despliegue
            echo "Deployment completed. Checking app..."
            curl -I http://localhost:8080/demo/ || echo "Curl check completed"

